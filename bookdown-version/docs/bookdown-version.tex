\documentclass[]{book}
\usepackage{lmodern}
\usepackage{amssymb,amsmath}
\usepackage{ifxetex,ifluatex}
\usepackage{fixltx2e} % provides \textsubscript
\ifnum 0\ifxetex 1\fi\ifluatex 1\fi=0 % if pdftex
  \usepackage[T1]{fontenc}
  \usepackage[utf8]{inputenc}
\else % if luatex or xelatex
  \ifxetex
    \usepackage{mathspec}
  \else
    \usepackage{fontspec}
  \fi
  \defaultfontfeatures{Ligatures=TeX,Scale=MatchLowercase}
\fi
% use upquote if available, for straight quotes in verbatim environments
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
% use microtype if available
\IfFileExists{microtype.sty}{%
\usepackage{microtype}
\UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts
}{}
\usepackage{hyperref}
\hypersetup{unicode=true,
            pdftitle={DASD Coding Standards},
            pdfauthor={Data Science Hub},
            pdfborder={0 0 0},
            breaklinks=true}
\urlstyle{same}  % don't use monospace font for urls
\usepackage{natbib}
\bibliographystyle{apalike}
\usepackage{color}
\usepackage{fancyvrb}
\newcommand{\VerbBar}{|}
\newcommand{\VERB}{\Verb[commandchars=\\\{\}]}
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
% Add ',fontsize=\small' for more characters per line
\usepackage{framed}
\definecolor{shadecolor}{RGB}{248,248,248}
\newenvironment{Shaded}{\begin{snugshade}}{\end{snugshade}}
\newcommand{\AlertTok}[1]{\textcolor[rgb]{0.94,0.16,0.16}{#1}}
\newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.77,0.63,0.00}{#1}}
\newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\BuiltInTok}[1]{#1}
\newcommand{\CharTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\CommentTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{#1}}
\newcommand{\DecValTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ErrorTok}[1]{\textcolor[rgb]{0.64,0.00,0.00}{\textbf{#1}}}
\newcommand{\ExtensionTok}[1]{#1}
\newcommand{\FloatTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ImportTok}[1]{#1}
\newcommand{\InformationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\NormalTok}[1]{#1}
\newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.81,0.36,0.00}{\textbf{#1}}}
\newcommand{\OtherTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{#1}}
\newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\RegionMarkerTok}[1]{#1}
\newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\StringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\VariableTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\WarningTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\usepackage{longtable,booktabs}
\usepackage{graphicx,grffile}
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
% Scale images if necessary, so that they will not overflow the page
% margins by default, and it is still possible to overwrite the defaults
% using explicit options in \includegraphics[width, height, ...]{}
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}
\IfFileExists{parskip.sty}{%
\usepackage{parskip}
}{% else
\setlength{\parindent}{0pt}
\setlength{\parskip}{6pt plus 2pt minus 1pt}
}
\setlength{\emergencystretch}{3em}  % prevent overfull lines
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
\setcounter{secnumdepth}{5}
% Redefines (sub)paragraphs to behave more like sections
\ifx\paragraph\undefined\else
\let\oldparagraph\paragraph
\renewcommand{\paragraph}[1]{\oldparagraph{#1}\mbox{}}
\fi
\ifx\subparagraph\undefined\else
\let\oldsubparagraph\subparagraph
\renewcommand{\subparagraph}[1]{\oldsubparagraph{#1}\mbox{}}
\fi

%%% Use protect on footnotes to avoid problems with footnotes in titles
\let\rmarkdownfootnote\footnote%
\def\footnote{\protect\rmarkdownfootnote}

%%% Change title format to be more compact
\usepackage{titling}

% Create subtitle command for use in maketitle
\providecommand{\subtitle}[1]{
  \posttitle{
    \begin{center}\large#1\end{center}
    }
}

\setlength{\droptitle}{-2em}

  \title{DASD Coding Standards}
    \pretitle{\vspace{\droptitle}\centering\huge}
  \posttitle{\par}
    \author{Data Science Hub}
    \preauthor{\centering\large\emph}
  \postauthor{\par}
    \date{}
    \predate{}\postdate{}
  
\usepackage{booktabs}

\begin{document}
\maketitle

{
\setcounter{tocdepth}{1}
\tableofcontents
}
\hypertarget{reviewer-notes}{%
\chapter{Reviewer notes}\label{reviewer-notes}}

This document is an early attempt at restructuring the current coding standards. At present, every part of the existing coding standards has been incorporated into this document. This is unlikely to be the case for the final product, but I didn't want to lose any essential information early on.

The minimum coding standards have been incorporated into the document \protect\hyperlink{mcstable}{here}. The formatting and sizing of the embedded html file isn't ideal at present, but provides an illustration of what could be done. Do we even still need the minimum coding standards? Can we easily put all the requirements in one place rather than splitting into two?

In addition, further information will be added at later stages - particularly in the form of links to external sites that will support the beginner in understanding some of the concepts.

This document hasn't been spellchecked or rigorously tested yet (e.g.~that links work etc.). This will be done at a later stage when structure has been agreed.

I've also added a section with the recommended \protect\hyperlink{wf}{workflow}. I wonder if this would ideally be brought up to the front of the beginning of the document to illustrate to beginners how each of the sections of the principles fits into their project work?

\hypertarget{intro}{%
\chapter{Introduction}\label{intro}}

This document contains the Data and Analytical Service Directorate's (DASD) coding standards.

\hypertarget{motivation}{%
\section{Motivation}\label{motivation}}

The DASD coding standards have been developed to help DASD adopt a unified/consistent approach to writing code, ensuring that our work is high quality, maintainable and reusable and that we are able to collaborate effectively across multiple projects {[}AMEND{]}.

The purpose of this document is to raise awareness of/hgihlight key coding principles and to briefly explain why we should code in such a way. These coding standards are by no means a list of rules, but seek to provide guidance on how we can achieve `best practice' in our coding. The more of these you follow, the easier life will be for you and your colleagues. These are open for discussion\ldots.

Coding practices should aim to create code that is:

\begin{itemize}
\tightlist
\item
  Reproducible

  \begin{itemize}
  \tightlist
  \item
    Measures should be put in place to ensure that code can be run across different machines and over time to produce the same results.\\
  \end{itemize}
\item
  Collaborative

  \begin{itemize}
  \tightlist
  \item
    Projects should be structured in such a way that we can collaborate effectively across multiple projects
  \item
    Code should be structured efficiently so that others can re-use existing code. This ensures consistency in approach and reduces the need for new code to be written and quality assured.\\
  \end{itemize}
\item
  Accurate

  \begin{itemize}
  \tightlist
  \item
    Code should be error free and appropriately quality assured.\\
  \end{itemize}
\item
  Understandable

  \begin{itemize}
  \tightlist
  \item
    Code should be structured, commented and documented to ensure it can be understood easily by others and passed on to others with minimal additional instruction.
  \end{itemize}
\end{itemize}

\hypertarget{structure}{%
\section{Guidance structure}\label{structure}}

The first part of this document contains the four coding principles, with additional details on the practical actions people should take to achieve these.

There is the recommended workflow for coding projects - this can be used to aid understanding of the steps that should be taken in a project and how the coding principles fit into the project lifecycle.

The final section includes a checklist of actions to be taken to achieve the principles. This is a condensed list of the material covered in the coding principles section.

\hypertarget{contributing}{%
\section{Contributing}\label{contributing}}

If you think that something is missing or not quite right you should either:\\
1. \protect\hyperlink{versioncontrol}{Contribute directly}\\
2. \href{https://github.com/moj-analytical-services/our-coding-standards/issues}{Raise an issue}

\hypertarget{principles}{%
\chapter{Coding Principles}\label{principles}}

The coding principles have been designed to help DASD adopt a unified/consistent approach to writing code, ensuring that our work is high quality, maintainable and reusable and that we are able to collaborate effectively across multiple projects {[}AMEND{]}.

Note that the specific actions recommended within this document, although grouped under each of the four principles, do overlap between the principles - they have been placed where they were deemed to fit best.

They are guidance, not The Law - there will always be edge cases, but you should expect to be challenged if you go your own way.

Code should be:
{[}\textbf{Update after rewriting individual sections}{]}

\textbf{1. \protect\hyperlink{understand}{Understandable}}

\begin{itemize}
\tightlist
\item
  Write a \protect\hyperlink{readme}{README} for your project\\
\item
  Use \protect\hyperlink{defaults}{sensible defaults} unless you have a great reason not to
\item
  Write \protect\hyperlink{functions}{functions} where needed\\
\item
  \protect\hyperlink{style}{Stylistic}:

  \begin{itemize}
  \tightlist
  \item
    Apply a \protect\hyperlink{linter}{linter}
  \item
    Ensure \protect\hyperlink{names}{variable names} are meaningful
  \item
    Code should be \protect\hyperlink{ccc}{correct, clear and concise}
  \item
    \protect\hyperlink{errors}{Handle errors}\\
  \item
    Other team members \protect\hyperlink{users}{are users too} - treat them with respect
  \end{itemize}
\end{itemize}

\textbf{2. \protect\hyperlink{accurate}{Accurate}}

\begin{itemize}
\tightlist
\item
  Ensure code is \protect\hyperlink{review}{reviewed}
\item
  Complete \protect\hyperlink{unittest}{unit testing}
\end{itemize}

\textbf{3. \protect\hyperlink{collaborate}{Collaborative}}

\begin{itemize}
\tightlist
\item
  Use the \protect\hyperlink{versioncontrol}{github workflow} across all projects\\
\item
  \protect\hyperlink{knowledge}{Share} the knowledge
\end{itemize}

\textbf{4. \protect\hyperlink{reproduce}{Reproducible}}

\begin{itemize}
\tightlist
\item
  Manage \protect\hyperlink{projdep}{project dependencies}
\item
  Optimise for \protect\hyperlink{change}{change}\\
\item
  Analyses should be \protect\hyperlink{githash}{simple and easy to reproduce} on another machine.
\end{itemize}

\hypertarget{understand}{%
\section{Understandable}\label{understand}}

It is crucial that we write code in a way that is understandable - through making sure that it is structured, commented and documented appropriately. This will mean that it can be understood easily by others and passed on to other staff with minimal additional instruction. This is clearly aids collboration and accuracy. {[}Amend{]}

\hypertarget{structure2}{%
\subsection{Code structure}\label{structure2}}

There should be clear logical separation of parameters, assumptions, data and code, with appropriate documentation.

\hypertarget{data}{%
\subsubsection*{Data}\label{data}}
\addcontentsline{toc}{subsubsection}{Data}

\begin{itemize}
\item
  MOJ data should never be committed to the Github repository - even a `private' repo isn't secure. Instead, data should be stored in an s3 bucket or in Athena. {[}Link to ap guidance{]}.
\item
  Small data files that are not MOJ data can be committed to the Github repo (e.g.~parameters, csv containing assumptions, mock data for unit tests, lookup table) - these should be stored in a `data' folder within the project folder.{[}Link to github with example project structure{]}
\item
  Prefer text format (e.g.~csv) to Excel\\
\item
  It should be easy for others to change parameters and data without needed to understand the full codebase.
\end{itemize}

\hypertarget{readme}{%
\subsubsection*{Documentation}\label{readme}}
\addcontentsline{toc}{subsubsection}{Documentation}

\begin{itemize}
\item
  Your project should include a README - by writing a README for your project you're helping others (and your future self) to be able to understand and run your project. Find our template README \href{https://github.com/moj-analytical-services/our-coding-standards/blob/master/README_template.md}{here}.
\item
  You have added a description to your Github repository and tagged it with appropriate tags This will allow your project to be discoverable and reusable by others.
\item
  Any functions you create should have appropriate documentation
\item
  Your code should be appropriately commented
\item
  Try to make your commit messages as informative as possible
\end{itemize}

\hypertarget{functions}{%
\subsubsection*{Abstractions}\label{functions}}
\addcontentsline{toc}{subsubsection}{Abstractions}

Where appropriate, abstractions should be used if possible, e.g.~functions, packages, modules etc. This makes code easier to understand, maintain and extend.

For R, you should use packages as fundamental units of code. For Python, you should factor code out into modules. In javascript, you should generally be using multiple \texttt{.js} files. For visualisation code, there should be a separation of concerns between the data model, and the code that visualises your data.

If you end up using a piece of code 3 times, it's probably worth turning it into a function and separating it out into a separate script. For more information on how to write functions, see \href{https://github.com/moj-analytical-services/writing_functions_in_r}{here}. As a general rule, functions should be less than about 50 lines long.

All non trivial functions are documented using the programming language's accepted standard.
This means that other users can understand your code more easily. If your functions are short and well documented, there is often little need for additional code comments.
For Python follow \href{https://www.python.org/dev/peps/pep-0008/}{PEP8} and particularly \href{https://www.python.org/dev/peps/pep-0257/}{PEP257}.
For R, use \texttt{roxygen2} to document your functions.

\hypertarget{coding-style}{%
\subsection{Coding style}\label{coding-style}}

\hypertarget{defaults}{%
\subsubsection{Defaults}\label{defaults}}

There are often many ways of tackling a given problem. As a team, it makes sense to standardise our approach, not because one approach is necessarily better than all others, but because collaboration is easier if there is less diversity in our approaches. This section sets out sensible defaults which you are expected to follow. They are not strict rules, but you will be expected to explain the benefits of alternative approaches if you want to do something different.

\begin{longtable}[]{@{}ll@{}}
\toprule
\begin{minipage}[b]{0.27\columnwidth}\raggedright
Language\strut
\end{minipage} & \begin{minipage}[b]{0.67\columnwidth}\raggedright
Defaults\strut
\end{minipage}\tabularnewline
\midrule
\endhead
\begin{minipage}[t]{0.27\columnwidth}\raggedright
R\strut
\end{minipage} & \begin{minipage}[t]{0.67\columnwidth}\raggedright
Follow \href{http://adv-r.had.co.nz/Style.html}{Hadley's Style Guide}
* Default to packages from the \href{http://tidyverse.org/}{Tidyverse}, because they have been carefully designed to work together effectively as part of a modern data analysis workflow. More info can be found here: \href{http://r4ds.had.co.nz}{R for Data Science by Hadley Wickham}. For example:
* Prefer tibbles to data.frames
* Use ggplot2 rather than base graphics
* Use the pipe \texttt{\%\textgreater{}\%} appropriately, but not always e.g.~see \href{https://twitter.com/hadleywickham/status/603883121197514752}{here}.
* Prefer \texttt{purrr} to the \texttt{apply} family of functions. See \href{http://r4ds.had.co.nz/iteration.html\#the-map-functions}{here}
* Use the package name when calling a function. For example, using dplyr::mutate() rather than just mutate()
* Use \href{https://rstudio.github.io/packrat/}{Packrat} for R dependencies - it's required by the Analytical Platform if you need to deploy your work.
* R Packages are the \href{http://r-pkgs.had.co.nz/}{fundamental unit of reproducable R code.}\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.27\columnwidth}\raggedright
Python\strut
\end{minipage} & \begin{minipage}[t]{0.67\columnwidth}\raggedright
\begin{itemize}
\tightlist
\item
  Follow {[}PEP8{]}
\item
  Use Python 3
\item
  Use pandas for data analysis
\item
  Use \texttt{loc} and \texttt{iloc} to write to data frames
\item
  Use Altair for basic data visualisation
\item
  Use Scikit Learn for machine learning
\item
  Use SQLAlchemy and pandas for database interactions, rather than writing your own SQL
\end{itemize}\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.27\columnwidth}\raggedright
Encoding and CSVs\strut
\end{minipage} & \begin{minipage}[t]{0.67\columnwidth}\raggedright
Use unicode. This means you should convert inputs that include non-ASCII characters to unicode as early as possible in your data processing workflow. If you are outputting to text files, these should be encoded in utf-8. Your output csvs should pass \href{https://csvlint.io/}{this} csv linter.\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.27\columnwidth}\raggedright
SQL\strut
\end{minipage} & \begin{minipage}[t]{0.67\columnwidth}\raggedright
Use Postgres or SQLite where possible, rather than other SQL database backends.\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.27\columnwidth}\raggedright
GIS\strut
\end{minipage} & \begin{minipage}[t]{0.67\columnwidth}\raggedright
\begin{itemize}
\tightlist
\item
  Use PostGIS as your GIS backend
\item
  Prefer conducting your GIS analysis in code, e.g.~using SQL, rather than point and click in a GUI
\item
  Use QGIS if you need a GUI.
\end{itemize}\strut
\end{minipage}\tabularnewline
\bottomrule
\end{longtable}

\hypertarget{style}{%
\subsubsection*{Coding Style}\label{style}}
\addcontentsline{toc}{subsubsection}{Coding Style}

In addition to the above coding defaults, the following actions will help you to write understandable code.

\hypertarget{names}{%
\subsubsection{Naming conventions}\label{names}}

\begin{itemize}
\tightlist
\item
  Don't be cute or jokey when naming things.
\item
  Names convey meaning - well-named functions \& variables can remove the need for a comment and make life a little easier for other readers, including your future self!
\item
  Avoid meaningless names like `obj' / `result' / `foo'.
\item
  Use single-letter variables only where the letter represents a well-known mathematical property (e.g.~e = mc\^{}2), or where their meaning is otherwise clear
\end{itemize}

\hypertarget{ccc}{%
\subsubsection{Clear and concise code}\label{ccc}}

\begin{itemize}
\tightlist
\item
  Choose clarity over cleverness - use advanced language tricks with care.
\item
  Code should be \href{https://en.wikipedia.org/wiki/Don\%27t_repeat_yourself}{DRY} - which stands for `Don't Repeat Yourself'. - The \href{https://en.wikipedia.org/wiki/Rule_of_three_(computer_programming)}{`Rule of Three'} is a good approach to managing duplication. Less code is usually better - but not at the expense of clarity.\\
\item
  Ensure that your tests and linters run automatically on all pull requests, if that is possible, by \ldots{}
\item
  Use code comments judiciously:
\end{itemize}

\begin{quote}
Good code is its own best documentation. As you're about to add a comment, ask yourself, ``How can I improve the code so that this comment isn't needed?'' Improve the code and then document it to make it even clearer.'' - Steve McConnell
\end{quote}

Comments are for explaining why something is needed, not how it works. Appropriate use of comments means it is easier to understand how code works at a later date. Before commenting, consider whether the comment fits better into the function's documentation than in a comment.

\hypertarget{linter}{%
\subsubsection{Apply a linter}\label{linter}}

Apply a linter to easily review your code formatting. This means our coding style will be consistent across projects. It will also make it easier for others to understand our code.

In RStudio, the keyboard shortcut `ctrl+shift+A' will reformat your code and automate some of the process of passing the linter. If you apply the linter as you work, rather than at the end, you will find it much easier to write code that passes the linter first time.

\begin{itemize}
\tightlist
\item
  For R use \href{https://cran.r-project.org/web/packages/lintr/readme/README.html}{Lintr} and follow \href{http://adv-r.had.co.nz/Style.html}{Hadley's Style Guide}\\
\item
  For Python, use {[}pylint{]} and follow {[}PEP8{]}
\end{itemize}

\hypertarget{errors}{%
\subsubsection{Helpful error messages}\label{errors}}

Accept this and code defensively when calling other services.
Every HTTP call could error or hang - handle failures appropriately and fail fast. Don't let long-running external calls impact your user experience.
Aim to provide useful information to end users and people working on the code, when something fails.

\hypertarget{accurate}{%
\section{Accurate}\label{accurate}}

Code should be error free and appropriately quality assured. Alongside simple sense-checking, two of the key mechanisms for ensuring that code is accurate are unit testing and project review.

\hypertarget{unittest}{%
\subsection{Unit testing}\label{unittest}}

Testing our code helps to ensure that it is both correct and robust - unit tests help to give confidence that your code actually does what you think it does. For further guidance on what you should test, see the \href{https://github.com/moj-analytical-services/coffee-and-coding-public/tree/master/2019-12-06\%20Testing\%20as\%20part\%20of\%20an\%20Analytical\%20Project}{Coffee and Coding `Testing' session}. {[}AMEND{]} - do we need to expand beyond unit testing?

As a broad description, unit tests should exist to check that your actual results match your expected results, in particular, testing any functions you create.

{[}AMEND{]} What exactly are we expecting people to test?
Unit tests should test, as a minimum, any functions you create. Unit tests exist at the function level, which test a range of parameters. The purpose of these granular tests is to ensure the code continues to give the correct answer in a range of cases, and even in edge cases (where unusual inputs are provided).

{[}AMEND{]}
* Ensure that your tests and linters run automatically on all pull requests, if that is possible, by setting up \href{https://travis-ci.org/}{TravisCI} on your repo. This will probably be more complicated than it is worth if your repo is private due to restrictions that are applied to the free TravisCI accounts

There are a number of tools to enable unit testing.

\hypertarget{testing-in-r}{%
\subsubsection*{Testing in R}\label{testing-in-r}}
\addcontentsline{toc}{subsubsection}{Testing in R}

In R, consider using the \href{https://github.com/r-lib/testthat}{testthat} package. For an introduction to using testthat, try reading this \href{https://katherinemwood.github.io/post/testthat/}{blog post} from Inattentional Coffee or this \href{https://towardsdatascience.com/unit-testing-in-r-68ab9cc8d211}{Towards Data Science post}. For an example unit tests within a project, see \href{https://github.com/RobinL/costmodelr/tree/master/tests}{here}.

\hypertarget{testing-in-python}{%
\subsubsection*{Testing in Python}\label{testing-in-python}}
\addcontentsline{toc}{subsubsection}{Testing in Python}

There are various approaches to unit testing in Python. Consider using \href{https://docs.python.org/3/library/unittest.html}{unittest} in the Python core library. Another option is \href{https://docs.pytest.org/en/latest/}{pytest}. See also \href{http://python-guide-pt-br.readthedocs.io/en/latest/writing/tests/}{here}

\hypertarget{testing-in-javascript}{%
\subsubsection*{Testing in Javascript}\label{testing-in-javascript}}
\addcontentsline{toc}{subsubsection}{Testing in Javascript}

See \href{http://busypeoples.github.io/post/testing-d3-with-jasmine/}{here} for testing with javascript

For data vis in Javascript, you need unit tests of routines that manipulate your data or data structures. Visual checks are sufficient of visualisation outputs, but you must make visual checks of the output against real data, and some test datasets that produce predictable output (e.g.~where values are set to 1, 0.5 etc.)

\hypertarget{review}{%
\subsection{Project Review}\label{review}}

Code review provides additional assurance that code logic is correct, and also the review should provide comments on code and problem structuring. For smaller projects, the review only needs to be a simple read-through and sanity check.

Code reviews should be initiated through the creation of a pull request {[}LINK{]}. The review should typically involve the reviewer pulling the code to their local machine, testing it, and leaving comments in the pull request.

Remember that it's always easier (for both you and your reviewers) if you commit and push your changes regularly.You should merge branches into master regularly so that reviewers review little and often, rather than attempting to review your entire codebase all at once.

\hypertarget{performing-good-peer-review}{%
\subsubsection*{Performing good peer review}\label{performing-good-peer-review}}
\addcontentsline{toc}{subsubsection}{Performing good peer review}

When you review someone's pull request you become the gatekeeper to the master branch - this is a \emph{very} important job! If you're tasked with this and you're wondering how to proceed asking yourself these questions is a good place to start\ldots{}

1: Do I understand what the code is doing? \protect\hyperlink{users}{Did it need to be explained} to me? \protect\hyperlink{ccc}{Could it be simpler}?

2: Are they using \protect\hyperlink{defaults}{packages / libraries sensibly}?

3: Does it need to be \protect\hyperlink{ccc}{tested} (and is it tested with sufficient coverage)?

4: \protect\hyperlink{ccc}{Does it work}? Does it work on my machine?

5: Are there edge cases that might \protect\hyperlink{errors}{break The Thing}?

{[}AMEND{]}
* Ensure that your tests and linters run automatically on all pull requests, if that is possible, by setting up \href{https://travis-ci.org/}{TravisCI} on your repo. This will probably be more complicated than it is worth if your repo is private due to restrictions that are applied to the free TravisCI accounts

If you're reviewing the code of a more experienced coder, this is \textbf{a chance to learn} and you have \emph{every} right to ask for an explanation if there's something that is unclear. It's in everyone's interest that you understand what you're reading and it could well be that you don't yet understand it because the author has made a mistake or overcomplicated something. So \emph{don't hold back}.

If you're on the receiving end of feedback, from anyone at all, this is\ldots{} \textbf{a chance to learn!}

\hypertarget{collaborate}{%
\section{Collaborative}\label{collaborate}}

It is vital that we're able to collaborate across projects, to share both workload and expertise, and that this collaboration can occur both simultaneously and over time.

Part of this is \protect\hyperlink{projdep}{managing dependencies} so projects can be run on another machine. Another key part is the use of Github for enabling code sharing. Checking the code into Github is a key part of the version control workflow.

\hypertarget{versioncontrol}{%
\subsection{Version Control}\label{versioncontrol}}

Code is version controlled using Git and checked into Github.
You can find a guide to using Git with R \href{http://happygitwithr.com/}{here}
You are able to maintain a continuously quality controlled `master' version of the code, whilst also being able to test new features and functionality.

The `Master' branch is protected, and contains only QAed code
When you create your git project using \texttt{git\ init}, immediately branch off to a development branch e.g.~using \texttt{git\ checkout\ -b\ dev}, and work on this branch.\\
Merge code into master using pull requests in github. A protected master branch guarantees that all pull requests have been reviewed before they are merged.

We follow ``github flow'', to keep branches small and short-lived, and ensure knowledge is shared.

\hypertarget{github-flow-is-a-working-practice-that-helps-to}{%
\subsubsection*{Github-Flow is a working practice that helps to:}\label{github-flow-is-a-working-practice-that-helps-to}}
\addcontentsline{toc}{subsubsection}{Github-Flow is a working practice that helps to:}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Maintain overall code quality\\
\item
  Facilitate collaboration on a single project\\
\item
  Protect the codebase
\end{enumerate}

We have tweaked it a little from what is \href{https://guides.github.com/introduction/flow/}{described on GitHub}

\hypertarget{there-are-6-steps-to-our-process}{%
\subsubsection*{There are 6 steps to our process:}\label{there-are-6-steps-to-our-process}}
\addcontentsline{toc}{subsubsection}{There are 6 steps to our process:}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Create or clone a repo.
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# For example, to clone this repo.}
\FunctionTok{git}\NormalTok{ clone git@github.com:moj-analytical-services/our-coding-standards.git}
\end{Highlighting}
\end{Shaded}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{1}
\item
  Create an issue in Github that describes what you're working on
  To create an issue, use \href{https://guides.github.com/features/issues/}{the Github website}.
\item
  Create a new branch for the work you're about to do, with a name corresponding to the issue
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# To create a new branch and switch onto it.}
\FunctionTok{git}\NormalTok{ checkout -b my-new-sensibly-named-branch}
\end{Highlighting}
\end{Shaded}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{3}
\tightlist
\item
  Make some commits on the new branch.
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# Make some changes then stage each file you've changed - e.g. file1.txt and file2.txt.}
\FunctionTok{git}\NormalTok{ add file1.txt}
\FunctionTok{git}\NormalTok{ add file2.txt}
\CommentTok{# etc}

\CommentTok{# Commit your changes using a descriptive commit message.}
\FunctionTok{git}\NormalTok{ commit}

\CommentTok{# This will take you into your default text editor}
\CommentTok{# Write a descriptive commit message}
\end{Highlighting}
\end{Shaded}

\begin{quote}
\textbf{Note:}
If you have not configured your text editor, you may get stuck in Vim. You can exit using the following command: \texttt{:q!}. Then configure your default text editor for Git
\end{quote}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{git}\NormalTok{ config --global core.editor }\OperatorTok{<}\NormalTok{my-favourite-text-editor}\OperatorTok{>}
 \CommentTok{# Then try again}
\FunctionTok{git}\NormalTok{ commit}
\end{Highlighting}
\end{Shaded}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{4}
\tightlist
\item
  When you're ready, submit a pull request and wait for peer-review.
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# push your branch to the remote repo}
\FunctionTok{git}\NormalTok{ push origin my-new-sensibly-named-branch}
\CommentTok{# then go to github, open a PR and invite at least one reviewer}
\end{Highlighting}
\end{Shaded}

Make sure that you reference the issue in your pull request, by using the hash (\#) symbol - see \href{https://help.github.com/articles/autolinked-references-and-urls/}{here} for further guidance. This makes it easy in future to see what changes were made to the code in response to the issue.

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{5}
\item
  To make further changes, just make more commits on the same branch and push them to the remote repo again.
\item
  Once peer review is complete, and any comments addressed, merge into the master branch using a \href{https://github.com/blog/2243-rebase-and-merge-pull-requests}{rebase}.
\item
  The version of master on Github is now ahead of the version of master on your local machine. Bring your local version up to date using \texttt{git\ checkout\ master}, \texttt{git\ pull}. You are now in sync with Github, and ready to start a new branch.
\end{enumerate}

The \textbf{master branch should be 100\% functional at all times}, on any machine. Please ensure it is \href{https://help.github.com/articles/about-protected-branches/}{protected} and that your tests and / or linters run automatically on all pull requests.

For some further reading we strongly suggest reading this \href{https://gist.github.com/blackfalcon/8428401}{article} that explains these git commands and others in a bit more detail.

If you want to test this out, clone this repo and make a contribution :)

\hypertarget{gitlink}{%
\subsubsection*{Useful links for using github}\label{gitlink}}
\addcontentsline{toc}{subsubsection}{Useful links for using github}

\begin{itemize}
\tightlist
\item
  \href{https://jennybc.github.io/2014-05-12-ubc/ubc-r/session2.4_github.html}{A guide to getting started with github}\\
\item
  Github guide on \href{https://user-guidance.services.alpha.mojanalytics.xyz/github.html\#creating-your-project-repo-on-github}{analytical platform guidance}\\
\item
  List of basic \href{https://guides.github.com/introduction/git-handbook/}{git commands}
\end{itemize}

\hypertarget{knowledge}{%
\subsection{Share the knowledge}\label{knowledge}}

We also collaborate through sharing knowledge. If you produce something reusable, package it \& share it with others.

There are a number of channels through which coding knowledge is shared in DASD:\\
* Slack channels (key channels are: \href{https://app.slack.com/client/T1PU1AP6D/C1Z8Q18LS}{\#data\_science}, \href{https://app.slack.com/client/T1PU1AP6D/C1PUCG719}{\#r}, \href{https://app.slack.com/client/T1PU1AP6D/C1Q09V86S}{\#python})\\
* Coffee and Coding (resources \href{https://github.com/moj-analytical-services/Coffee-and-Coding}{here})\\
* \href{https://trello.com/b/zAwm6sCc/dasd-training}{DASD training Trello}\\
* \href{https://docs.google.com/document/d/1R4hBMf26T9HEnCdVz56PpZhwiCv5RhberYL3BxOSKsA/edit}{R learning resources}

\hypertarget{reproduce}{%
\section{Reproducible}\label{reproduce}}

We want to create reproducible code to ensure that it can be used by others, both for collaboration and to allow effective review and accountability, that it keeps working over time (protected from external changes) and so that it can be easily reused by others in their own projects (delete this last one?).

There are a number of steps that we can take to ensure that our code is as reproducible as possible.

\hypertarget{projdep}{%
\subsection{Manage project dependencies}\label{projdep}}

Your project will depend on an number of external factors, such as software or packages. These dependencies may mean that your project won't work on others' machines or may not work on your machine at a later date (e.g.~as external packages are updated over time). To ensure that this doesn't become an issue for your project, you should use some kind of dependency management tool.

\hypertarget{dependency-management-tools}{%
\subsubsection*{Dependency management tools}\label{dependency-management-tools}}
\addcontentsline{toc}{subsubsection}{Dependency management tools}

For Python, use \href{https://github.com/moj-analytical-services/coffee-and-coding-public/blob/master/2019-10-30\%20Conda/conda.pdf}{Conda}.
For R, you can use \href{https://github.com/moj-analytical-services/coffee-and-coding-public/blob/master/2019-10-30\%20Conda/conda.pdf}{Conda}, \href{https://rstudio.github.io/packrat/}{Packrat} or \href{https://blog.rstudio.com/2019/11/06/renv-project-environments-for-r/}{Renv}.
For javascript, include third party library dependencies in the project as \texttt{.js} files

\hypertarget{githash}{%
\subsubsection*{Include a git hash}\label{githash}}
\addcontentsline{toc}{subsubsection}{Include a git hash}

If practical, the output of your code should include the git hash of the code that produced it. By doing so, the analysis should be
more reproducible, there is no ambiguity about the specific code that was used to generate it.

\hypertarget{r}{%
\paragraph{R}\label{r}}
\addcontentsline{toc}{paragraph}{R}

You can access the git hash using either of the following code:
snippets.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(git2r)}
\NormalTok{repo <-}\StringTok{ }\KeywordTok{repository}\NormalTok{(}\StringTok{"."}\NormalTok{)}
\KeywordTok{print}\NormalTok{(}\KeywordTok{repository_head}\NormalTok{(repo))}
\end{Highlighting}
\end{Shaded}

or

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{print}\NormalTok{(}\KeywordTok{system}\NormalTok{(}\StringTok{"git rev-parse --short HEAD"}\NormalTok{, }\DataTypeTok{intern =} \OtherTok{TRUE}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\hypertarget{python}{%
\paragraph{Python}\label{python}}
\addcontentsline{toc}{paragraph}{Python}

You can access the git hash using the following code:

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ subprocess}
\KeywordTok{def}\NormalTok{ get_git_revision_hash():}
    \ControlFlowTok{return}\NormalTok{ subprocess.check_output([}\StringTok{'git'}\NormalTok{, }\StringTok{'rev-parse'}\NormalTok{, }\StringTok{'HEAD'}\NormalTok{])}
\KeywordTok{def}\NormalTok{ get_git_revision_short_hash():}
    \ControlFlowTok{return}\NormalTok{ subprocess.check_output([}\StringTok{'git'}\NormalTok{, }\StringTok{'rev-parse'}\NormalTok{, }\StringTok{'--short'}\NormalTok{, }\StringTok{'HEAD'}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\hypertarget{format}{%
\subsection{Format}\label{format}}

If the output is a report, the write up should be fully reproducible, or as close as possible.

\begin{itemize}
\tightlist
\item
  Avoid workflows that require manually copying and pasting results between documents.\\
\item
  For Python, consider using Jupyter notebooks. For R, use \texttt{rmarkdown}.
\end{itemize}

\hypertarget{change}{%
\subsection{Optimize for change}\label{change}}

\begin{itemize}
\tightlist
\item
  Don't try to solve every conceivable problem up-front, instead focus on making your code easy to change when needed.
\item
  Don't prematurely optimize - choose clarity over performance, unless there is a serious performance issue that needs to be addressed.
\item
  Change can come in several forms, including hardware - your code will eventually be run on a colleague's machine or a server somewhere. Without overcomplicating things, write your code with this in mind. For example, use relative paths (e.g.~\texttt{./file\_in\_the\_project\_directory.R} rather than \texttt{/Users/my\_username/development/my\_project/file\_in\_the\_project\_directory.R})
\end{itemize}

\hypertarget{wf}{%
\chapter{Workflow}\label{wf}}

The recommended workflow for coding projects in DASD is:

Create/clone \protect\hyperlink{versioncontrol}{github repo}\\
Create \protect\hyperlink{versioncontrol}{issue}\\
Create \protect\hyperlink{versioncontrol}{branch}\\
Set up \protect\hyperlink{projdep}{dependency management}\\
Build in \protect\hyperlink{unittest}{unit testing}\\
Commit \protect\hyperlink{versioncontrol}{changes}\\
\protect\hyperlink{review}{Pull request/QA}


\end{document}
